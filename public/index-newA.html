<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IVR Prototype</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 2rem; }
    h1   { margin-top: 0; }
    .hidden { display: none; }
    #upload, #ivr { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
    #pad   { display: grid; grid-template-columns: repeat(3, 60px); gap: 10px; }
    #pad button { aspect-ratio: 1; font-size: 1.5rem; }
    button { padding: 0.4rem 0.8rem; font-size: 1rem; cursor: pointer; }
    #status { min-height: 1.4em; }
  </style>
</head>
<body>

  <h1>IVR Prototype</h1>

  <!-- Upload panel -->
  <section id="upload">
    <input type="file" id="file" />
    <button id="upload-btn">Upload & Build IVR</button>
    <div id="status"></div>
  </section>

  <!-- IVR panel -->
  <section id="ivr" class="hidden">
    <button id="dial-btn">ðŸ“ž Dial 097086003 now</button>
    <button id="end-btn"  class="hidden">End call</button>
    <audio  id="player" controls></audio>

    <div id="pad" class="hidden">
      <button>1</button><button>2</button><button>3</button>
      <button>4</button><button>5</button><button>6</button>
      <button>7</button><button>8</button><button>9</button>
      <button>*</button><button>0</button><button>#</button>
    </div>

    <button id="new-btn">New IVR menu</button>
  </section>

  <script>
    /* ---------- State ---------- */
    let tree = null, current = null, es = null;

    /* ---------- Helpers ---------- */
    const $        = s => document.querySelector(s);
    const show     = el => el.classList.remove('hidden');
    const hide     = el => el.classList.add   ('hidden');
    const play     = src => { $('#player').src = src; $('#player').play?.(); };

    /* ---------- Upload & build ---------- */
    $('#upload-btn').onclick = async () => {
      const file = $('#file').files[0];
      if (!file) return alert('Choose a YAML or OPML file first');
      $('#status').textContent = 'â³ Uploadingâ€¦';
      const fd = new FormData(); fd.append('file', file);

      try {
        const { id } = await fetch('/upload', { method: 'POST', body: fd }).then(r => r.json());

        /* open SSE stream for progress */
        es = new EventSource(`/progress/${id}`);
        es.onmessage = e => {
          const { step, total } = JSON.parse(e.data);
          $('#status').textContent = `â³ Creating IVR menu item ${step} of ${total}â€¦`;
        };
        es.addEventListener('done', () => {
          $('#status').textContent = 'âœ… Build complete â€“ loadingâ€¦';
          es.close();
          loadTree(id);
        });
      } catch (err) {
        console.error(err);
        $('#status').textContent = 'âŒ Build failed';
      }
    };

    async function loadTree(id) {
      tree = await fetch(`/tree/${id}`).then(r => r.json());
      current = tree;

      hide($('#upload'));
      show($('#ivr'));
      $('#status').textContent = 'âœ… IVR ready';
    }

    /* ---------- Dial / End ---------- */
    $('#dial-btn').onclick = () => {
      hide($('#dial-btn'));
      show($('#end-btn'));
      show($('#pad'));
      current = tree;
      play(current.audio);
    };

    $('#end-btn').onclick = () => {
      $('#player').pause();
      hide($('#pad'));
      hide($('#end-btn'));
      show($('#dial-btn'));
      current = null;
    };

    /* ---------- Keypad ---------- */
    $('#pad').querySelectorAll('button').forEach(btn => {
      btn.onclick = () => {
        const d = parseInt(btn.textContent, 10);
        if (Number.isNaN(d)) return;
        const next = current?.children?.[d - 1];
        if (!next) return;
        current = next;
        if (current.audio) play(current.audio);
      };
    });

    /* ---------- New IVR menu ---------- */
    $('#new-btn').onclick = () => {
      $('#player').pause();
      hide($('#ivr'));
      show($('#upload'));
      $('#file').value = '';
      $('#status').textContent = '';
      tree = current = null;
    };
  </script>
</body>
</html>

